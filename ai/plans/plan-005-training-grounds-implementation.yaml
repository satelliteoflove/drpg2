version: "0.5"
plan_id: "training-grounds-001"
project_name: "Training Grounds Town Service Implementation"
agent_profile: "ai-coding-agent-v1"

context:
  business_goal: "Implement the Training Grounds town service for character roster management, creation, and multi-classing"
  non_functional_requirements:
    - "UI must match Temple and Inn screens for consistency"
    - "All services must be free (no gold costs)"
    - "Support full character roster beyond active party"
    - "Enable multi-classing with stat and spell retention"
  personas:
    - name: "Player"
      need: "Create and manage characters from town, experiment with multi-classing"
    - name: "Developer"
      need: "Testable service following established patterns"

architecture:
  overview: |
    The Training Grounds follows the established 4-component town service pattern with Scene,
    StateManager, InputHandler, and UIRenderer. It adds character roster management to GameState
    and implements multi-classing mechanics. UI/UX matches Temple and Inn screens exactly.
  constraints:
    - "Must follow existing town service patterns"
    - "UI must match Temple/Inn look and feel"
    - "Cannot break existing character/party systems"
    - "Must be fully testable via AI Interface"
  integration_points:
    - "TownScene menu integration"
    - "GameState roster storage"
    - "Character entity extensions"
    - "Save/Load system updates"

tooling:
  primary_language: "TypeScript"
  frameworks: ["Webpack", "Canvas API"]
  package_manager: "npm"
  coding_standards:
    testing: "AI Interface (window.AI)"
    patterns: "Scene-based state management, Service-oriented architecture"

entry_node: "infrastructure"

nodes:
  - id: "infrastructure"
    status: "Completed"
    materialization: 1.0
    description: "Set up character roster infrastructure"
    detailed_description: |
      Add character roster support to the game's core systems:
      1. Modify src/types/GameTypes.ts to add characterRoster: Character[] to GameState
      2. Update src/utils/SaveManager.ts to persist/load the roster
      3. Create src/systems/training/ directory structure
      4. Add basic TrainingGroundsScene registration in src/core/Game.ts
      5. Add Training Grounds option to src/scenes/TownScene.ts menu

      This establishes the foundation for storing characters beyond the active party.
    outputs:
      - "src/types/GameTypes.ts"
      - "src/utils/SaveManager.ts"
      - "src/systems/training/"
      - "src/core/Game.ts"
      - "src/scenes/TownScene.ts"
      - "src/scenes/TrainingGroundsScene.ts"
      - "src/__tests__/testUtils.ts"
    agent_action: "Add character roster to GameState and create Training Grounds infrastructure"
    role: "agent"
    downstream: ["scene-orchestration", "character-class-change"]
    notes: |
      Completed 2025-10-04. Also created basic TrainingGroundsScene with placeholder UI.
      Fixed escape key handling (lowercase 'escape' not 'Escape').
      Updated test utilities to include characterRoster in test game states.
      All TypeScript checks passing. Dev server confirmed working.
      Scene navigation: Town -> Training Grounds -> Town (via Escape) verified.

  - id: "scene-orchestration"
    status: "Completed"
    materialization: 1.0
    description: "Create Training Grounds scene orchestrator"
    detailed_description: |
      Implement the main scene class following the Temple/Inn pattern:
      1. Create src/scenes/TrainingGroundsScene.ts extending Scene base class
      2. Implement lifecycle methods: enter(), exit(), update(), render(), renderLayered()
      3. Instantiate and delegate to StateManager, InputHandler, UIRenderer, ServiceHandler
      4. Handle scene transitions and state context passing
      5. Follow the ~90 line pattern from InnScene.ts and TempleScene.ts

      This orchestrates all Training Grounds functionality.
    inputs:
      - "src/systems/training/"
    outputs:
      - "src/scenes/TrainingGroundsScene.ts"
      - "src/systems/training/TrainingGroundsStateManager.ts"
      - "src/systems/training/TrainingGroundsServiceHandler.ts"
      - "src/systems/training/TrainingGroundsUIRenderer.ts"
      - "src/systems/training/TrainingGroundsInputHandler.ts"
    agent_action: "Create TrainingGroundsScene following Temple/Inn pattern"
    role: "agent"
    downstream: ["state-management"]
    notes: |
      Completed 2025-10-04. Created all 4 components (StateManager, ServiceHandler, UIRenderer, InputHandler).
      Scene properly orchestrates components with DebugLogger integration.
      Basic state enum (MAIN, LEAVE) and placeholder rendering implemented.
      Escape key navigation works correctly.
      All TypeScript checks passing, webpack compiled successfully.

  - id: "state-management"
    status: "Completed"
    materialization: 1.0
    description: "Implement Training Grounds state machine"
    detailed_description: |
      Create the state manager for menu navigation:
      1. Create src/systems/training/TrainingGroundsStateManager.ts
      2. Define TrainingGroundsState enum with all states (main, createName, createRace, etc.)
      3. Implement state transitions and validation
      4. Provide getters for current state context
      5. Handle character selection and menu option tracking

      States needed:
      - main (Create, Inspect, Roster, Leave)
      - createName through createConfirm (creation flow)
      - inspectSelectCharacter through inspectRename (inspection flows)
      - roster (view all characters)

      Model after TempleStateManager.ts (~200 lines).
    inputs:
      - "src/scenes/TrainingGroundsScene.ts"
    outputs:
      - "src/systems/training/TrainingGroundsStateManager.ts"
      - "src/types/TrainingGroundsTypes.ts"
    agent_action: "Create state machine for Training Grounds navigation"
    role: "agent"
    downstream: ["input-handling", "ui-rendering"]
    notes: |
      Completed 2025-10-06. Created TrainingGroundsTypes.ts with 18-state enum and interfaces.
      Implemented TrainingGroundsStateManager with bonus point system (1d4+6 with 10% chance of +10).
      Characters with ≤10 points start at Level 4. Dynamic class eligibility based on stats/gender.
      Fixed Character/ICharacter type collision - renamed interface to ICharacter throughout codebase.
      All TypeScript checks passing, webpack compiles successfully.

  - id: "character-class-change"
    status: "Completed"
    materialization: 1.0
    description: "Add class change method to Character entity"
    detailed_description: |
      Extend Character entity with multi-classing support:
      1. Modify src/entities/Character.ts to add changeClass() method
      2. Implement mechanics: reset level to 1, reset XP to 0, increase age by 1
      3. Unequip all equipment but keep in inventory
      4. Retain: current stats, total HP, percentage of MP, all learned spells
      5. Handle spell retention (spells stay even if new class can't normally cast them)

      This enables the core multi-classing feature.
    inputs:
      - "src/entities/Character.ts"
    outputs:
      - "src/entities/Character.ts"
    agent_action: "Add changeClass() method to Character entity"
    role: "agent"
    downstream: ["service-handler"]
    notes: |
      Completed 2025-10-04. Added changeClass(newClass) method to Character entity.
      Mechanics implemented: preserves stats, HP value, MP percentage, and knownSpells.
      Unequips all equipment to inventory. Resets level to 1, XP to 0, increments age.
      Recalculates maxHp, maxMp, and experienceModifier for new class.
      All TypeScript checks passing.

  - id: "input-handling"
    status: "Ready"
    materialization: 0.8
    description: "Implement Training Grounds input handler"
    detailed_description: |
      Create keyboard input processing for all states:
      1. Create src/systems/training/TrainingGroundsInputHandler.ts
      2. Use MenuInputHandler from src/ui/components/MenuInputHandler.ts
      3. Implement handlers for each state (handleMainMenu, handleCreateName, etc.)
      4. Handle text input for name entry and rename
      5. Implement bonus point allocation controls (arrow keys to adjust stats)
      6. Add escape key for back navigation

      Model after InnInputHandler.ts (~400 lines).
    inputs:
      - "src/systems/training/TrainingGroundsStateManager.ts"
    outputs:
      - "src/systems/training/TrainingGroundsInputHandler.ts"
    agent_action: "Create input handler for all Training Grounds states"
    role: "agent"
    downstream: ["service-handler"]

  - id: "ui-rendering"
    status: "Ready"
    materialization: 0.8
    description: "Implement Training Grounds UI renderer"
    detailed_description: |
      Create visual rendering matching Temple/Inn UI:
      1. Create src/systems/training/TrainingGroundsUIRenderer.ts
      2. Copy UI patterns from TempleUIRenderer.ts and InnUIRenderer.ts
      3. Implement render methods for each state
      4. Use same box drawing characters, layouts, and text positioning
      5. Render character stats, races, classes with proper formatting
      6. Show bonus point allocation interface with real-time updates
      7. Display roster in same format as Inn's character list

      Must exactly match Temple and Inn visual style (~600 lines).
    inputs:
      - "src/systems/training/TrainingGroundsStateManager.ts"
    outputs:
      - "src/systems/training/TrainingGroundsUIRenderer.ts"
    agent_action: "Create UI renderer matching Temple/Inn visual style"
    role: "agent"
    downstream: ["character-creation-flow"]

  - id: "service-handler"
    status: "Ready"
    materialization: 0.75
    description: "Implement Training Grounds service logic"
    detailed_description: |
      Create business logic handler for all operations:
      1. Create src/systems/training/TrainingGroundsServiceHandler.ts
      2. Implement createCharacter() with full creation flow
      3. Add deleteCharacter() with confirmation
      4. Implement renameCharacter() with validation
      5. Add changeCharacterClass() using Character.changeClass()
      6. Implement getRoster() for listing all characters
      7. Add validation methods for stats, names, class requirements

      All services are FREE - no gold transaction logic needed (~350 lines).
    inputs:
      - "src/systems/training/TrainingGroundsInputHandler.ts"
      - "src/entities/Character.ts"
    outputs:
      - "src/systems/training/TrainingGroundsServiceHandler.ts"
    agent_action: "Create service handler for character management operations"
    role: "agent"
    downstream: ["character-creation-flow"]

  - id: "character-creation-flow"
    status: "Blocked"
    materialization: 0.7
    description: "Implement complete character creation with bonus points"
    detailed_description: |
      Implement the full character creation wizard:
      1. Name entry with validation
      2. Race selection showing stat ranges
      3. Gender selection with class restrictions preview
      4. Bonus point allocation system:
         - Roll 1d4+6 base (7-10 points)
         - 10% chance for +10 (17-20 total)
         - If 17-19, another 10% chance for +10 (27-29 total)
         - Characters with ≤10 points start at Level 4
      5. Real-time class eligibility as points are distributed
      6. Class selection from eligible classes
      7. Alignment selection
      8. Confirmation and save to roster

      Use DiceRoller utility for random rolls.
    inputs:
      - "src/systems/training/TrainingGroundsUIRenderer.ts"
      - "src/systems/training/TrainingGroundsServiceHandler.ts"
    outputs:
      - "Updated Training Grounds components"
    agent_action: "Implement full character creation with bonus point system"
    role: "agent"
    downstream: ["inspect-operations"]

  - id: "inspect-operations"
    status: "Blocked"
    materialization: 0.65
    description: "Implement character inspection features"
    detailed_description: |
      Add all character inspection operations:
      1. Character selection from roster
      2. View character details (stats, equipment, spells, status)
      3. Delete character with confirmation prompt
      4. Class change flow:
         - Show eligible classes based on current stats
         - Display warnings (level reset, age increase)
         - Confirmation with details of what's retained
      5. Rename character with validation

      UI should match Temple's character selection patterns.
    inputs:
      - "src/systems/training/TrainingGroundsServiceHandler.ts"
    outputs:
      - "Updated Training Grounds components"
    agent_action: "Implement inspect menu operations"
    role: "agent"
    downstream: ["roster-view"]

  - id: "roster-view"
    status: "Blocked"
    materialization: 0.6
    description: "Implement character roster display"
    detailed_description: |
      Create roster view showing all characters:
      1. List all characters in roster
      2. Show: name, race, class, level, status, location
      3. Use Inn's character display format for consistency
      4. Handle pagination if roster is large
      5. Show "In Party" vs "In Town" status
      6. Display total roster count

      Match Inn's visual style for character listings.
    inputs:
      - "src/systems/training/TrainingGroundsUIRenderer.ts"
    outputs:
      - "Updated Training Grounds UI renderer"
    agent_action: "Implement roster view display"
    role: "agent"
    downstream: ["ai-interface-integration"]

  - id: "ai-interface-integration"
    status: "Blocked"
    materialization: 0.55
    description: "Add Training Grounds to AI Interface"
    detailed_description: |
      Extend AI Interface for Training Grounds testing:
      1. Modify src/core/AIInterface.ts
      2. Add getTrainingGroundsInfo() method returning:
         - inTrainingGrounds: boolean
         - currentState: string
         - rosterCount: number
         - selectedCharacter: Character info
         - availableActions: string[]
      3. Add helper methods for testing creation flow
      4. Expose bonus point allocation state
      5. Enable automated testing of all operations

      Follow pattern from getShopInfo(), getInnInfo(), etc.
    inputs:
      - "src/core/AIInterface.ts"
    outputs:
      - "src/core/AIInterface.ts"
    agent_action: "Add Training Grounds testing methods to AI Interface"
    role: "agent"
    downstream: ["testing-validation"]

  - id: "testing-validation"
    status: "Blocked"
    materialization: 0.5
    description: "Test and validate all Training Grounds features"
    detailed_description: |
      Comprehensive testing of all functionality:
      1. Test character creation flow end-to-end
      2. Verify bonus point allocation and Level 4 starting
      3. Test all inspect operations (view, delete, rename)
      4. Validate class change mechanics:
         - Stats retained correctly
         - Spells preserved
         - Level/XP reset
         - Equipment unequipped
      5. Verify roster persistence through save/load
      6. Test UI matches Temple/Inn exactly
      7. Validate all services are free
      8. Use AI Interface for automated verification

      Run npm run typecheck and fix any issues.
    inputs:
      - "All Training Grounds components"
    outputs:
      - "Verified Training Grounds implementation"
    agent_action: "Test all Training Grounds features using AI Interface"
    role: "agent"
    acceptance_criteria:
      - "Character creation works from town"
      - "Bonus point system matches spec"
      - "Multi-classing preserves stats and spells"
      - "UI matches Temple/Inn screens"
      - "All operations are free"
      - "AI Interface provides full testing"
      - "Save/load preserves roster"